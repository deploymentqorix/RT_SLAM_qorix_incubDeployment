<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backend Test Client</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1e1e1e; color: #d4d4d4; margin: 0; padding: 20px; display: flex; flex-direction: column; gap: 30px; }
        .container { background-color: #252526; border: 1px solid #333; border-radius: 8px; padding: 20px; }
        h2 { color: #4ec9b0; margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px;}
        input[type="text"] { background-color: #3c3c3c; border: 1px solid #555; color: #d4d4d4; padding: 8px; border-radius: 4px; width: 300px; }
        button { background-color: #0e639c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #1177bb; }
        button.disconnect { background-color: #9c2b0e; }
        button.disconnect:hover { background-color: #bb3d11; }
        #wsStatus { font-weight: bold; padding: 5px 10px; border-radius: 4px; display: inline-block; }
        #wsLog, #apiResponse { width: 98%; height: 200px; background-color: #1e1e1e; color: #ce9178; border: 1px solid #333; border-radius: 4px; font-family: "Consolas", "Monaco", monospace; padding: 10px; white-space: pre; overflow-wrap: normal; overflow-x: scroll;}
        .flex-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>WebSocket Data Streamer (`data_streamer`)</h2>
        <div class="flex-group">
            <label for="wsUrl">URL:</label>
            <input type="text" id="wsUrl" value="ws://localhost:8765">
            <button id="wsConnectBtn">Connect</button>
            <button id="wsDisconnectBtn" class="disconnect">Disconnect</button>
            <span id="wsStatus">DISCONNECTED</span>
        </div>
        <h3>Live Data Log:</h3>
        <textarea id="wsLog" readonly></textarea>

        <h3>Send Command to Backend:</h3>
        <div class="flex-group">
            <input type="text" id="wsCommand" placeholder='{"command": "reset_slam"}' style="width: 400px;">
            <button id="wsSendBtn">Send Command</button>
        </div>
    </div>

    <div class="container">
        <h2>REST API Server (`api_server`)</h2>
        <div class="flex-group">
            <label for="apiUrl">Endpoint:</label>
            <input type="text" id="apiUrl" value="http://localhost:8000/api/v1/system/health">
            <button id="apiFetchBtn">Fetch Data</button>
        </div>
        <h3>API Response:</h3>
        <pre id="apiResponse"><code>Waiting for API call...</code></pre>
    </div>

    <script>
        // --- DOM Element References ---
        const wsUrlInput = document.getElementById('wsUrl');
        const wsConnectBtn = document.getElementById('wsConnectBtn');
        const wsDisconnectBtn = document.getElementById('wsDisconnectBtn');
        const wsStatus = document.getElementById('wsStatus');
        const wsLog = document.getElementById('wsLog');
        const wsCommandInput = document.getElementById('wsCommand');
        const wsSendBtn = document.getElementById('wsSendBtn');

        const apiUrlInput = document.getElementById('apiUrl');
        const apiFetchBtn = document.getElementById('apiFetchBtn');
        const apiResponse = document.getElementById('apiResponse').querySelector('code');

        let websocket = null;

        // --- WebSocket Logic ---
        function connectWebSocket() {
            const url = wsUrlInput.value;
            if (!url) { alert('WebSocket URL cannot be empty.'); return; }

            websocket = new WebSocket(url);

            websocket.onopen = () => {
                updateStatus('CONNECTED', '#388e3c');
                logMessage('--- Connection Established ---');
            };

            websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    logMessage(JSON.stringify(data, null, 2));
                } catch (e) {
                    logMessage(event.data); // Log as plain text if not JSON
                }
            };

            websocket.onerror = (error) => {
                updateStatus('ERROR', '#d32f2f');
                logMessage(`--- WebSocket Error: ${error.message || 'Could not connect.'} ---`);
            };

            websocket.onclose = () => {
                updateStatus('DISCONNECTED', '#d32f2f');
                logMessage('--- Connection Closed ---');
                websocket = null;
            };
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
            }
        }
        
        function sendWebSocketCommand() {
            const command = wsCommandInput.value;
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                if (!command) { alert('Command cannot be empty.'); return; }
                websocket.send(command);
                logMessage(`--> SENT: ${command}`);
            } else {
                alert('WebSocket is not connected.');
            }
        }

        // --- REST API Logic ---
        async function fetchApiData() {
            const url = apiUrlInput.value;
            if (!url) { alert('API URL cannot be empty.'); return; }
            
            apiResponse.textContent = 'Fetching...';
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                apiResponse.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                apiResponse.textContent = `Error: ${error.message}`;
            }
        }
        
        // --- Helper Functions ---
        function updateStatus(text, color) {
            wsStatus.textContent = text;
            wsStatus.style.backgroundColor = color;
        }

        function logMessage(message) {
            wsLog.value += `${message}\n\n`;
            wsLog.scrollTop = wsLog.scrollHeight; // Auto-scroll to bottom
        }

        // --- Event Listeners ---
        wsConnectBtn.addEventListener('click', connectWebSocket);
        wsDisconnectBtn.addEventListener('click', disconnectWebSocket);
        wsSendBtn.addEventListener('click', sendWebSocketCommand);
        apiFetchBtn.addEventListener('click', fetchApiData);
        
        // Initial status
        updateStatus('DISCONNECTED', '#d32f2f');

    </script>
</body>
</html>